#!/bin/bash
set -e

if [ -n "ONLY_KEY" ]; then
    packages="$(rpm -qa --qf '%{NAME}-%{VERSION}-%{RELEASE} %{SIGPGP:pgpsig} %{SIGGPG:pgpsig}\n' | grep -v "$ONLY_KEY" | grep -v gpg-pubkey | awk '{print $1}')"
fi

packages="$packages $(zypper rm --details -D -u -y zypper | grep '^[a-z]' | grep -v procps)"

echo Removing $packages
rpm --nodeps -v -e $packages

echo Removing zypper data
rm -rf /etc/zypp \
    /var/cache/zypp \
    /var/log/zypp \
    /var/lib/zypp

echo Removing luet
rm -rf /usr/bin/luet \
   /var/cache/luet \
   /var/luet \
   /etc/luet

echo Removing rpm
rpm --nodeps -v -e rpm rpm-config-SUSE suse-module-tools
rm -rf /usr/lib/rpm \
    /usr/lib/sysimage/rpm \
    /etc/rpm

echo Removing extra kernel weight
rm -rf /boot/vmlinux*

echo Removing self
rm /usr/bin/finalize

if ! command -v man >/dev/null; then
    echo Removing man pages
    find /usr/share/man -type f -exec rm {} \;
fi

if [ -e /usr/lib/os-release.tmpl ]; then
    echo Setting up /etc/os-release
    export OS_NAME=${OS_NAME:-NoNameOS} OS_VERSION="${OS_VERSION:-0.0.0}" OS_GIT="${OS_GIT:-HEAD}"
    cat /usr/lib/os-release.tmpl | envsubst > /usr/lib/os-release
    rm /usr/lib/os-release.tmpl
    ln -sf ../usr/lib/os-release /etc/os-release
fi 
